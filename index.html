<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ちいくじプロンプター</title>
    
    <!-- ホーム画面用アイコン (Apple Touch Icon) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2322c55e'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-size='50' fill='white'>ち</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --font-main: "Hiragino Mincho ProN", "MS Mincho", serif;
            --line-spacing: 0rem; 
            --cam-scale: 1;
            --cam-y: 0;
            --bg-color: #000000;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #fff;
            font-family: var(--font-main);
            overflow: hidden;
            height: 100dvh;
            touch-action: none;
        }

        /* 1. プロンプター（背面レイヤー） */
        #prompter-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5; /* 映像より後ろ */
            overflow: hidden;
            pointer-events: auto;
        }

        /* 2. カメラプレビュー（前面レイヤー：文字よりも手前） */
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10; /* 文字より前 */
            pointer-events: none; /* 下の文字操作・スクロールを邪魔しない */
            opacity: 0.75; /* 文字が透けて見えるように調整 */
            background: transparent;
        }

        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1) scale(var(--cam-scale)) translateY(calc(var(--cam-y) * 1px));
            transition: transform 0.1s ease-out;
        }

        /* 16:9 形式表示用 */
        #video-container.mode-16-9 #video-preview {
            aspect-ratio: 16 / 9;
            height: auto;
            width: 100%;
        }

        /* スクロールコンテンツ：ノッチ領域（safe-area）の最上部から表示 */
        .scrolling-content {
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            padding-top: 0; /* ノッチ領域の背後まで文字を流す */
            padding-bottom: 85vh;
            will-change: transform;
        }

        .script-line {
            margin-bottom: var(--line-spacing);
            text-align: left;
            text-shadow: 2px 2px 8px rgba(0,0,0,1), -1px -1px 4px rgba(0,0,0,1);
            line-height: 1.3;
            font-weight: bold;
            word-break: break-all;
        }

        /* コントロールUI表示管理 */
        #settings-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #settings-panel.ui-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        /* 下部メインコントロール */
        #main-controls {
            position: fixed;
            bottom: max(30px, env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: flex;
            gap: 20px;
            align-items: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            padding: 14px 28px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* 録画ボタン（文字を大きく調整） */
        .record-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #ff4444;
            border: 4px solid #fff;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-size: 20px; /* 録画中の文字をさらに大きく */
            font-weight: 800;
            line-height: 1.1;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255,0,0,0.3);
        }

        .record-btn.recording {
            background-color: #fff;
            color: #ff4444;
            border-radius: 16px;
            transform: scale(0.95);
            animation: pulse-border 1.5s infinite;
        }

        .timer-text { font-family: monospace; font-size: 15px; margin-top: 4px; font-weight: bold; }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        #toggle-ui-visibility {
            background: #22c55e;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }

        .config-card {
            background: rgba(0,0,0,0.92);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 24px;
            padding: 16px;
            width: 95%;
            max-width: 500px;
            position: fixed;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 140;
            max-height: 45vh;
            overflow-y: auto;
        }

        #edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 300;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }

        input[type="range"] {
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
        }
        
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: none;
        }
    </style>
</head>
<body>

    <!-- プロンプター（背面レイヤー：画面最上部まで文字が表示される） -->
    <div id="prompter-container">
        <div id="scrolling-content" class="scrolling-content"></div>
    </div>

    <!-- カメラ（前面レイヤー：文字に重なって表示される） -->
    <div id="video-container">
        <video id="video-preview" autoplay playsinline muted></video>
    </div>

    <!-- 設定パネル -->
    <div id="settings-panel">
        <div class="config-card flex flex-col gap-4">
            <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">速度 (低速微調整)</label>
                    <input type="range" id="speed-range" min="0" max="50" value="10" class="w-full">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">文字サイズ</label>
                    <input type="range" id="size-range" min="20" max="120" value="48" class="w-full">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">行間調整 (初期最小)</label>
                    <input type="range" id="spacing-range" min="0" max="100" value="0" class="w-full">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">カメラ上下位置 (中央デフォルト)</label>
                    <input type="range" id="cam-y-range" min="-500" max="500" value="0" class="w-full">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">カメラズーム (画面端まで)</label>
                    <input type="range" id="cam-size-range" min="50" max="300" value="100" class="w-full">
                </div>
                <div class="flex items-center gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">背景色</label>
                        <input type="color" id="bg-color-picker" value="#000000">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-1">形式</label>
                        <div class="flex gap-2">
                            <button id="format-9-16-btn" class="toggle-btn active text-[10px]">9:16</button>
                            <button id="format-16-9-btn" class="toggle-btn text-[10px]">16:9</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center justify-between border-t border-white/10 pt-3 gap-2">
                <div class="flex gap-2">
                    <button id="font-serif-btn" class="toggle-btn active">明朝</button>
                    <button id="font-sans-btn" class="toggle-btn">ゴシック</button>
                </div>
                <div class="flex gap-2">
                    <button id="edit-btn" class="bg-white/10 p-2 rounded-lg text-xs">台本編集</button>
                    <button id="reset-btn" class="bg-white/10 p-2 rounded-lg text-xs font-bold">冒頭に戻る</button>
                    <button id="refresh-app-btn" class="bg-green-600/30 border border-green-500/50 p-2 rounded-lg text-xs font-bold">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- メインコントロール -->
    <div id="main-controls">
        <button id="play-pause-btn" class="bg-blue-600 w-11 h-11 rounded-full flex items-center justify-center">
            <span id="play-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg></span>
        </button>
        <button id="record-btn" class="record-btn"></button>
        <button id="toggle-ui-visibility">
            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.05-1.465 1.655C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
            </svg>
        </button>
    </div>

    <!-- 台本編集モーダル -->
    <div id="edit-modal">
        <h2 class="text-xl font-bold mb-4">台本を編集</h2>
        <textarea id="script-input" class="w-full h-2/3 bg-zinc-800 text-white p-4 rounded-lg border border-zinc-700 mb-4 font-sans"></textarea>
        <div class="flex gap-4">
            <button id="save-script" class="flex-1 bg-blue-600 py-3 rounded-lg font-bold">適用する</button>
            <button id="close-modal" class="flex-1 bg-zinc-700 py-3 rounded-lg font-bold">キャンセル</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video-preview');
        const videoContainer = document.getElementById('video-container');
        const prompterContainer = document.getElementById('prompter-container');
        const content = document.getElementById('scrolling-content');
        const settingsPanel = document.getElementById('settings-panel');
        const toggleUiBtn = document.getElementById('toggle-ui-visibility');
        const playBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const recordBtn = document.getElementById('record-btn');
        const speedRange = document.getElementById('speed-range');
        const sizeRange = document.getElementById('size-range');
        const spacingRange = document.getElementById('spacing-range');
        const camYRange = document.getElementById('cam-y-range');
        const camSizeRange = document.getElementById('cam-size-range');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const modal = document.getElementById('edit-modal');
        const scriptInput = document.getElementById('script-input');
        
        const fontSerifBtn = document.getElementById('font-serif-btn');
        const fontSansBtn = document.getElementById('font-sans-btn');
        const format916Btn = document.getElementById('format-9-16-btn');
        const format169Btn = document.getElementById('format-16-9-btn');
        const refreshAppBtn = document.getElementById('refresh-app-btn');

        let isPlaying = false;
        let isRecording = false;
        let isUiVisible = true;
        let scrollY = 0, lastTimestamp = 0;
        let mediaRecorder, recordedChunks = [];
        let recordStartTime = 0;
        let timerInterval = null;
        
        let startY = 0, startScrollY = 0;
        let initialPinchDist = 0;
        let initialFontSize = 0;

        const allFeaturesText = `ちいくじプロンプター：全機能ガイド

このアプリに実装されている機能一覧です：

1. 【手前に自分、奥に文字】
カメラ映像が手前に重なり、文字は背後から流れます。自分の表情を常に確認しながら読めます。

2. 【ノッチ・ステータスバー領域の活用】
iPhoneの最上部まで文字が表示されます。画面全域を台本エリアとして使えます。

3. 【超低速スクロール】
0〜50の範囲で、非常にゆっくりとしたスピードを精密に調整できます。

4. 【文字カスタマイズ】
サイズに加え、行間（初期値：最小）をスライダーで変更できます。

5. 【ピンチズーム対応】
画面を2本指でピンチ（広げる・縮める）することで、直感的に文字サイズを変更できます。

6. 【タップ操作】
画面のどこをタップしても再生・停止が切り替わります（UI非表示時も有効）。

7. 【カメラ精密調整】
ズーム（初期値：フル）と上下位置（初期位置：中央）をバーで変更できます。

8. 【録画機能】
録画中はボタンが白く変化し、大きな文字で「録画中」と経過時間が表示されます。

9. 【背景色＆フォント切り替え】
背景色を自由に変更でき、明朝体とゴシック体を瞬時に切り替え可能です。

10. 【ビデオ形式】
SNS用の9:16、YouTube用の16:9を選択して撮影できます。

11. 【UI非表示】
緑のボタンで設定パネルを隠せます。録画・再生ボタンは残り続けます。

12. 【冒頭に戻る】
長い台本でも一気にスタート地点へ戻れます。

最高の動画を撮影しましょう！`;

        function init() {
            updateContent(allFeaturesText);
            setupCamera();
            
            spacingRange.oninput = () => { document.documentElement.style.setProperty('--line-spacing', `${spacingRange.value / 16}rem`); };
            camSizeRange.oninput = () => { document.documentElement.style.setProperty('--cam-scale', camSizeRange.value / 100); };
            camYRange.oninput = () => { document.documentElement.style.setProperty('--cam-y', camYRange.value); };
            bgColorPicker.oninput = () => { document.documentElement.style.setProperty('--bg-color', bgColorPicker.value); };
            
            requestAnimationFrame(animate);
        }

        /**
         * カメラのセットアップ
         * NotFoundError対策として複数の構成を試行するフォールバックを実装
         */
        async function setupCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error("Camera API not supported");
                return;
            }

            const constraintsList = [
                { video: { facingMode: 'user', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: true },
                { video: { facingMode: 'user' }, audio: true },
                { video: true, audio: true },
                { video: true } // オーディオなしでも試行
            ];

            for (const constraints of constraintsList) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    console.log("Camera access successful with:", constraints);
                    return;
                } catch (err) {
                    console.warn(`Attempt failed with ${err.name}:`, constraints);
                    // 次の制約へ
                }
            }
            alert("カメラデバイスが見つかりませんでした。ブラウザの権限設定を確認してください。");
        }

        function updateContent(text) {
            content.innerHTML = '';
            text.split('\n').forEach(line => {
                const div = document.createElement('div');
                div.className = 'script-line';
                div.textContent = line || '　';
                content.appendChild(div);
            });
            scrollY = 0;
        }

        function animate(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;
            const delta = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            if (isPlaying) {
                const speed = parseFloat(speedRange.value) / 1000 * delta;
                scrollY -= speed;
            }
            
            content.style.transform = `translate3d(0, ${scrollY}px, 0)`;
            const size = parseInt(sizeRange.value);
            content.querySelectorAll('.script-line').forEach(line => {
                line.style.fontSize = `${size}px`;
            });
            
            requestAnimationFrame(animate);
        }

        format916Btn.onclick = () => { videoContainer.classList.remove('mode-16-9'); format916Btn.classList.add('active'); format169Btn.classList.remove('active'); };
        format169Btn.onclick = () => { videoContainer.classList.add('mode-16-9'); format169Btn.classList.add('active'); format916Btn.classList.remove('active'); };
        fontSerifBtn.onclick = () => { document.body.style.setProperty('--font-main', '"Hiragino Mincho ProN", serif'); fontSerifBtn.classList.add('active'); fontSansBtn.classList.remove('active'); };
        fontSansBtn.onclick = () => { document.body.style.setProperty('--font-main', '"Hiragino Kaku Gothic ProN", sans-serif'); fontSansBtn.classList.add('active'); fontSerifBtn.classList.remove('active'); };
        refreshAppBtn.onclick = () => { window.location.reload(); };

        toggleUiBtn.onclick = (e) => {
            e.stopPropagation();
            isUiVisible = !isUiVisible;
            settingsPanel.className = isUiVisible ? '' : 'ui-hidden';
            toggleUiBtn.style.opacity = isUiVisible ? '1' : '0.4';
        };

        prompterContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                initialFontSize = parseInt(sizeRange.value);
            } else {
                isPlaying = false;
                updatePlayIcon();
                startY = e.touches[0].pageY;
                startScrollY = scrollY;
            }
        }, { passive: false });

        prompterContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                if (initialPinchDist > 0) {
                    const scale = dist / initialPinchDist;
                    const newSize = Math.max(20, Math.min(120, initialFontSize * scale));
                    sizeRange.value = Math.round(newSize);
                }
            } else {
                scrollY = startScrollY + (e.touches[0].pageY - startY);
            }
            e.preventDefault();
        }, { passive: false });

        prompterContainer.onclick = () => { isPlaying = !isPlaying; updatePlayIcon(); };

        function updatePlayIcon() {
            playIcon.innerHTML = isPlaying ? 
                '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>';
        }

        document.getElementById('reset-btn').onclick = (e) => { e.stopPropagation(); scrollY = 0; isPlaying = false; updatePlayIcon(); };
        recordBtn.onclick = (e) => { e.stopPropagation(); if (!isRecording) startRecording(); else stopRecording(); };

        function startRecording() {
            recordedChunks = [];
            const stream = video.srcObject;
            if (!stream) return;
            try { mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/mp4' }); } catch (e) { mediaRecorder = new MediaRecorder(stream); }
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const mimeType = mediaRecorder.mimeType.includes('mp4') ? 'video/mp4' : 'video/webm';
                const blob = new Blob(recordedChunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `chiikuji_${Date.now()}.${mimeType.includes('mp4') ? 'mp4' : 'webm'}`;
                a.click();
            };
            mediaRecorder.start();
            isRecording = true; recordBtn.classList.add('recording');
            recordStartTime = Date.now(); updateTimer(); timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
            const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
            const s = String(elapsed % 60).padStart(2, '0');
            recordBtn.innerHTML = `<div style="font-size: 20px;">録画中</div><div class="timer-text">${m}:${s}</div>`;
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            isRecording = false; recordBtn.classList.remove('recording'); recordBtn.textContent = '';
            clearInterval(timerInterval); timerInterval = null;
        }

        playBtn.onclick = (e) => { e.stopPropagation(); isPlaying = !isPlaying; updatePlayIcon(); };
        document.getElementById('edit-btn').onclick = (e) => { e.stopPropagation(); isPlaying = false; modal.style.display = 'block'; scriptInput.value = Array.from(content.querySelectorAll('.script-line')).map(d => d.textContent).join('\n'); };
        document.getElementById('close-modal').onclick = () => modal.style.display = 'none';
        document.getElementById('save-script').onclick = () => { updateContent(scriptInput.value); modal.style.display = 'none'; };

        init();
    </script>
</body>
</html>
